# FINAL_text_splitter_rewrite

## 1. 项目总结
本项目对 `TextSplitterService` 进行了彻底重构，以解决用户反馈的切分逻辑混乱、原子内容被破坏、分隔符缺失等问题。重构采用了 7 步流水线设计，严格区分了粗切、细化、子块拆分和原子处理阶段。

## 2. 主要变更
### 2.1 核心逻辑重写 (`_split_pdf_text`)
废弃了原有的递归混合逻辑，采用明确的线性步骤：
1.  **预处理**: HTML 表格转 Markdown。
2.  **原子化**: 识别图片 (`【...】`) 和表格，替换为 Token ID。
3.  **粗切**: 按一级标题 (`# `) 切分父块。
4.  **父块细化**: 对超限父块按段落递归拆分。
5.  **子块拆分**: 在父块内部拆分子块，确保原子 Token 独立。
6.  **原子超限处理**:
    *   **图片**: 按段落拆分。
    *   **表格**: 按行拆分，自动补全表头。
7.  **重组**: 使用用户指定的动态分隔符连接所有块。

### 2.2 关键 Bug 修复
*   **正则匹配失败**: 修复了表格匹配正则中的转义错误，确保表格被正确识别为原子内容。
*   **分隔符缺失**: 逻辑保证了原子内容前后必定插入子块分隔符。
*   **非标准格式支持**: 增强了图片和表格的正则兼容性（支持多行、DOTALL 模式）。

## 3. 交付物
*   `app/services/text_splitter_service.py`: 重构后的服务代码。
*   `docs/text_splitter_verification/`: 包含任务、设计、对齐和验收文档。

## 4. 后续建议
*   建议用户提供更多种类的非标准文档进行边缘测试。
*   目前原子 Token 的 ID 生成依赖于简单的计数，在极高并发或复杂嵌套下可能需要优化（当前场景足够）。
