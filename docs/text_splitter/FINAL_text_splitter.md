# FINAL_text_splitter

## 1. 任务总结
本次任务重构了 `TextSplitterService` 的 PDF 文本分块逻辑，实现了更智能的文档结构感知和内容保护机制。

## 2. 核心特性
### 2.1 结构化优先切分
*   采用递归策略，优先按 Markdown 标题层级 (`#` -> `######`) 切分。
*   确保父块尽可能对应完整的章节或语义单元。
*   支持“软限制”与“硬限制”策略：优先切分到内部预设值 (1280)，但允许不可分割的块扩展到用户输入的最大值。

### 2.2 原子内容保护与智能切分
*   **保护**: 图片解析内容 (`【...】`) 和 Markdown 表格在默认情况下被视为原子 Token，不会被标点或换行切断。
*   **智能切分**:
    *   **超大表格**: 若表格超过最大限制，自动按行切分为多个带有完整表头的子表格。
    *   **超大图片**: 若图片描述超过最大限制，自动按段落切分，并添加 `(分段)`/`(续)` 标记，保持语义连贯。

### 2.3 动态大小策略
*   **Internal Default**: Parent=1280, Sub=320。
*   **User Input**: 外部传入。
*   **逻辑**: `Target = min(User, Internal)`, `Max = User`。系统努力将块大小控制在 Target 以内，但允许在 Max 范围内浮动。

## 3. 代码变更
*   `app/services/text_splitter_service.py`: 全面重构。
*   `scripts/test_splitter.py`: 新增验证脚本。

## 4. 后续建议
*   目前的 HTML 表格转 Markdown 比较基础，如需支持复杂嵌套表格，建议引入 `BeautifulSoup` 或 `pandas`。
*   图片分段后的语义重组依赖于 LLM 的理解能力，建议在 Prompt 中给予提示。
